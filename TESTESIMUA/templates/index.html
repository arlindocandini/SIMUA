<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <title>Ocorr√™ncias</title>
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: Arial, sans-serif;
}

body {
    display: flex;
    min-height: 100vh;
}

.sidebar {
    width: 250px;
    background-color: #0a2a18;
    color: white;
    padding: 20px;
    height: 100vh; /* Altura total da viewport */
    position: fixed; /* Fixa a barra lateral */
    top: 0;
    left: 0;
    overflow-y: auto; /* Permite rolagem se o conte√∫do for muito longo */
    box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
}

.sidebar h2 {
    display: flex;
    align-items: center;
    gap: 10px;
    text-align: center;
    margin-bottom: 20px;
    font-size: 24px;
    font-weight: bold;
    color: #ffffff;
    padding-bottom: 10px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.1);
}

.sidebar h2 .logo {
    width: 40px;
    height: 40px;
    border-radius: 10%;
}

.sidebar a {
    color: white;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 15px;
    border-radius: 8px;
    transition: all 0.3s ease;
    font-size: 16px;
}

.sidebar a:hover {
    background-color: rgba(255, 255, 255, 0.1);
    transform: translateX(5px);
}

.sidebar a i {
    font-size: 18px;
    width: 24px;
    text-align: center;
}

.sidebar a i.fa-home { color: #FFD700; }
.sidebar a i.fa-list { color: #4CAF50; }
.sidebar a i.fa-chart-line { color: #1E90FF; }
.sidebar a i.fa-user { color: #FF4C4C; }
.sidebar a i.fa-users { color: #FFA500; }
.sidebar a i.fa-print { color: #00FF00; }
.sidebar a i.fa-map { color: #FF6347; }
.sidebar a i.fa-video { color: #8A2BE2; }

.main-content {
    margin-left: 250px; /* Espa√ßo para a barra lateral */
    flex: 1;
    padding: 20px;
    background-color: #ffffff;
    overflow-y: auto; /* Permite rolagem no conte√∫do principal */
}

.header {
    text-align: center;
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 20px;
}

.table-container {
    width: 100%;
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 10px;
    overflow: hidden;
}

th, td {
    padding: 12px;
    text-align: center;
    border-bottom: 1px solid #ddd;
}

th {
    background: #1b4428;
    color: white;
}

td img {
    width: 50px;
    height: 50px;
    border-radius: 5px;
}

.status {
    padding: 5px 10px;
    border-radius: 5px;
    color: white;
    font-weight: bold;
    text-align: center;
}

.status-urgente { background-color: yellow; color: black; }
.status-emergencia { background-color: red; }
.status-pouco-urgente { background-color: green; }
.status-nao-urgente { background-color: blue; }
.status-indefinido { background-color: gray; }

.button {
    padding: 8px 12px;
    background-color: #1b4428;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.button:hover {
    background-color: #0a2a18;
}

/* Estiliza√ß√£o do Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
    background-color: white;
    width: 40%;
    margin: 10% auto;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    font-size: 20px;
    font-weight: bold;
}

.modal-body {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    font-weight: bold;
    margin-bottom: 5px;
}

input, select, textarea {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 5px;
}

textarea {
    resize: none;
}

.modal-footer {
    display: flex;
    justify-content: space-between;
    margin-top: 15px;
}

.btn-confirm {
    background-color: green;
    color: white;
    padding: 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.btn-cancel {
    background-color: red;
    color: white;
    padding: 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.btn-confirm:hover, .btn-cancel:hover {
    opacity: 0.8;
}
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>
            <img src="static/imagens/logo.png" alt="Logo" class="logo"> <!-- Adicionando a logo -->
            Prefeitura
        </h2>
        <a href="/">
            <i class="fas fa-home"></i>
            Ocorr√™ncias
        </a>
        <a href="/ordens">
            <i class="fas fa-list"></i>
            Ordens de Servi√ßo (OS)
        </a>
        <a href="/dashboard">
            <i class="fas fa-chart-line"></i>
            Dashboard
        </a>
        <a href="/mapa"> <!-- Novo bot√£o: Mapa -->
            <i class="fas fa-map"></i>
            Mapa
        </a>
        <a href="/cameras"> <!-- Novo bot√£o: C√¢meras -->
            <i class="fas fa-video"></i>
            C√¢meras
        </a>
        <a href="/perfil">
            <i class="fas fa-user"></i>
            Perfil
        </a>
        <a href="/cadastro">
            <i class="fas fa-users"></i>
            Cadastrar Usu√°rios
        </a>
        <a href="/relatorios">
            <i class="fas fa-print"></i>
            Imprimir Relat√≥rios
        </a>
    </div>

    <div class="main-content">
        <div class="header">Ocorr√™ncias</div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Captura</th>
                        <th>Localiza√ß√£o</th>
                        <th>ID</th>
                        <th>Categoria</th>
                        <th>Status</th>
                        <th>Data de Registro</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody id = "tabela-ocorrencias" >
                    {% for img in imagens %}
                    <tr>
                        <td><img src="{{ url_for('Pasta_final', filename=img.arquivo) }}" alt="Ocorr√™ncia"></td>
                        <td>{{ img.localizacao }}</td>
                        <td>{{ img.id }}</td>
                        <td>{{ img.categoria }}</td>
                        <td class="status" style="background-color: {{ img.cor_status }};">{{ img.status }}</td>
                        <td>{{ img.data }}</td>
                        <td><button class="button" onclick="abrirModal('{{ img.localizacao }}', '{{ img.categoria }}', '{{ img.status }}')">Gerar OS</button></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

<!-- Modal (Popup) para Criar OS -->
<div id="modalOS" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-title">üõ† Nova Ordem de Servi√ßo</span>
            <span class="close" onclick="fecharModal()">‚úñ</span>
        </div>
        <div class="modal-body">
            <form id="formOS">
                <div class="form-group">
                    <label>üìç Localiza√ß√£o:</label>
                    <input type="text" id="osLocalizacao" readonly>
                </div>

                <div class="form-group">
                    <label>üìå Categoria:</label>
                    <input type="text" id="osCategoria" readonly>
                </div>

                <div class="form-group">
                    <label>üö¶ Status:</label>
                    <select id="osStatus">
                        <option value="Emerg√™ncia">üî¥ Emerg√™ncia</option>
                        <option value="Urgente">üü° Urgente</option>
                        <option value="Pouco Urgente">üü¢ Pouco Urgente</option>
                        <option value="N√£o Urgente">üîµ N√£o Urgente</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>üë§ Respons√°vel:</label>
                    <input type="text" id="osResponsavel" required>
                </div>

                <div class="form-group">
                    <label>üìÜ Prazo:</label>
                    <input type="date" id="osPrazo" required>
                </div>

                <div class="form-group">
                    <label>üõ† Equipe Respons√°vel:</label>
                    <select id="osEquipe">
                        <option value="Manuten√ß√£o">üîß Manuten√ß√£o</option>
                        <option value="El√©trica">‚ö° El√©trica</option>
                        <option value="Infraestrutura">üèóÔ∏è Infraestrutura</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>‚ö†Ô∏è Prioridade:</label>
                    <select id="osPrioridade">
                        <option value="Alta">üî• Alta</option>
                        <option value="M√©dia">‚ö†Ô∏è M√©dia</option>
                        <option value="Baixa">üí° Baixa</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>üìù Observa√ß√µes:</label>
                    <textarea id="osObservacoes"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-confirm" onclick="salvarOS()">‚úÖ Criar OS</button>
            <button class="btn-cancel" onclick="fecharModal()">‚ùå Cancelar</button>
        </div>
    </div>
</div>

<script>
    function abrirModal(localizacao, categoria, status) {
        document.getElementById("osLocalizacao").value = localizacao;
        document.getElementById("osCategoria").value = categoria;
        document.getElementById("osStatus").value = status;
        document.getElementById("modalOS").style.display = "block";
    }

    function fecharModal() {
        document.getElementById("modalOS").style.display = "none";
    }

    function salvarOS() {
        const osData = {
            localizacao: document.getElementById("osLocalizacao").value,
            categoria: document.getElementById("osCategoria").value,
            status: document.getElementById("osStatus").value,
            responsavel: document.getElementById("osResponsavel").value,
            prazo: document.getElementById("osPrazo").value,
            equipe: document.getElementById("osEquipe").value,
            prioridade: document.getElementById("osPrioridade").value,
            observacoes: document.getElementById("osObservacoes").value
        };

        fetch("/salvar_os", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(osData)
        })
        .then(response => response.json())
        .then(data => {
            alert("Ordem de Servi√ßo criada com sucesso!");
            fecharModal();  // Fecha o popup
            window.location.href = "/ordens"; // Redireciona para a p√°gina de ordens
        })
        .catch(error => console.error("Erro ao salvar OS:", error));
    }

    // Cache para evitar chamadas repetidas ao Nominatim
    const enderecoCache = {};

    // Fun√ß√£o para buscar endere√ßo usando Nominatim (OpenStreetMap)
    async function getEnderecoNominatim(lat, lon) {
        const key = `${lat},${lon}`;

        // Verifica se j√° est√° no cache
        if (enderecoCache[key]) {
            console.log(`‚úÖ Cache encontrado para: ${lat}, ${lon} ‚Üí ${enderecoCache[key]}`);
            return enderecoCache[key];
        }

        console.log(`üîç Buscando endere√ßo para: ${lat}, ${lon}`);

        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
            const data = await response.json();

            if (data.address) {
                // Formata o endere√ßo de forma compacta
                const enderecoFormatado = formatarEnderecoCompacto(data.address);
                enderecoCache[key] = enderecoFormatado; // Armazena no cache
                return enderecoFormatado;
            } else {
                console.warn(`‚ö†Ô∏è Nenhum endere√ßo encontrado para: ${lat}, ${lon}`);
                return `Coordenadas: (${lat}, ${lon})`;
            }
        } catch (error) {
            console.error("‚ùå Erro ao buscar endere√ßo:", error);
            return `Erro ao buscar endere√ßo (${lat}, ${lon})`;
        }
    }

    // Fun√ß√£o para formatar o endere√ßo de forma compacta (estilo Google Maps)
    function formatarEnderecoCompacto(endereco) {
        const { road, house_number, neighbourhood, suburb, city, town, village, postcode, state } = endereco;

        // Define a cidade (prioriza "city", depois "town", depois "village")
        const cidade = city || town || village;

        // Monta o endere√ßo no formato: Rua + N√∫mero, Bairro - Cidade - Estado, CEP
        const partesEndereco = [
            road ? road + (house_number ? `, ${house_number}` : "") : null, // Rua e n√∫mero (se dispon√≠vel)
            neighbourhood || suburb, // Bairro ou sub√∫rbio
            cidade, // Cidade
            state, // Estado
            postcode ? `, ${postcode}` : null // CEP (se dispon√≠vel)
        ].filter(Boolean); // Remove valores nulos/undefined

        return partesEndereco.join(" - ");
    }

    // Fun√ß√£o para atualizar a tabela de ocorr√™ncias
    async function atualizarOcorrencias() {
        try {
            const response = await fetch('/api/ocorrencias');
            const dados = await response.json();

            const tabela = document.getElementById('tabela-ocorrencias');
            if (!tabela) {
                console.error("Erro: Elemento 'tabela-ocorrencias' n√£o encontrado!");
                return;
            }

            tabela.innerHTML = ""; // Limpa a tabela antes de adicionar os novos dados

            for (const ocorrencia of dados) {
                const linha = document.createElement('tr');

                // Criando a estrutura da linha com c√©lula de endere√ßo vazia inicialmente
                linha.innerHTML = `
                    <td><img src="/static/Pasta_final/${ocorrencia.arquivo}" width="50"/></td>
                    <td class="endereco">Carregando...</td> <!-- Endere√ßo ser√° atualizado aqui -->
                    <td>${ocorrencia.id}</td>
                    <td>${ocorrencia.categoria}</td>
                    <td style="background-color: ${ocorrencia.cor_status}; padding: 5px; color: white;">${ocorrencia.status}</td>
                    <td>${ocorrencia.data}</td>
                    <td><button class="button" onclick="abrirModal('${ocorrencia.localizacao}', '${ocorrencia.categoria}', '${ocorrencia.status}')">Gerar OS</button></td>
                `;

                tabela.appendChild(linha);

                // Extraindo latitude e longitude da string da localiza√ß√£o
                const coordenadas = ocorrencia.localizacao.split(", ").map(Number);
                if (coordenadas.length === 2 && !isNaN(coordenadas[0]) && !isNaN(coordenadas[1])) {
                    const endereco = await getEnderecoNominatim(coordenadas[0], coordenadas[1]);
                    linha.querySelector(".endereco").innerText = endereco;
                } else {
                    console.warn(`‚ö†Ô∏è Coordenadas inv√°lidas para: ${ocorrencia.localizacao}`);
                    linha.querySelector(".endereco").innerText = `Coordenadas: ${ocorrencia.localizacao}`;
                }
            }
        } catch (error) {
            console.error("Erro ao atualizar ocorr√™ncias:", error);
        }
    }

    // Atualiza automaticamente a cada 30 segundos
    setInterval(atualizarOcorrencias, 30000);

    // Atualiza na primeira carga
    atualizarOcorrencias();
</script>
</body>
</html>
